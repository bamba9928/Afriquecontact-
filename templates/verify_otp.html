{% extends 'base.html' %}

{% block title %}Vérification WhatsApp{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg mt-10 text-center">
    <h2 class="text-2xl font-bold text-primary mb-4">Vérifiez votre numéro</h2>
    <p class="text-gray-600 mb-6">Un code a été envoyé sur votre WhatsApp. Entrez-le ci-dessous.</p>

    <form id="otpForm" class="space-y-4">
        <input type="text" id="code" placeholder="Ex: 123456" maxlength="6"
               class="w-full text-center text-2xl tracking-widest p-2 border-2 border-secondary rounded" required>

        <div id="msg" class="text-sm font-bold"></div>

        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">
            Valider
        </button>
    </form>
</div>

{% block scripts %}
<script>
    // Récupérer le téléphone depuis l'URL (?phone=...)
    const params = new URLSearchParams(window.location.search);
    const phone = params.get('phone');

    document.getElementById('otpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const code = document.getElementById('code').value;
        const msg = document.getElementById('msg');

        const response = await fetch('/api/auth/verify-whatsapp/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ phone: phone, code: code })
        });

        const data = await response.json();

        if (response.ok) {
            msg.className = "text-green-600";
            msg.innerText = "Succès ! Redirection...";
            // Stocker les tokens retournés
            localStorage.setItem('access_token', data.access);
            localStorage.setItem('refresh_token', data.refresh);
            setTimeout(() => window.location.href = '/', 1500);
        } else {
            msg.className = "text-red-600";
            msg.innerText = data.code || "Code incorrect.";
        }
    });
</script>
{% endblock %}
{% endblock %}